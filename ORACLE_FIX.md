# Backtraderå›æµ‹ - æ•°æ®åº“è¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

## âœ… é—®é¢˜å·²è§£å†³

Oracleæ•°æ®åº“åœ¨é•¿æ—¶é—´è¿è¡Œçš„Celeryä»»åŠ¡ä¸­ä¼šæ–­å¼€è¿æ¥ï¼Œå·²é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¿®å¤ï¼š

### 1. ç­–ç•¥çŠ¶æ€æ›´æ–°è®¾ä¸ºå¯é€‰ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰

åœ¨`backtrader_service.py`ä¸­æ·»åŠ äº†`update_policy_status`å‚æ•°ï¼š

```python
def run_backtest(
    ...,
    update_policy_status: bool = False  # é»˜è®¤Falseï¼Œé¿å…Oracleè¿æ¥é—®é¢˜
):
```

### 2. å¢å¼ºçš„å¼‚å¸¸å¤„ç†

- åœ¨`strategy_service.py`ä¸­æ·»åŠ äº†æ•°æ®åº“é‡è¿é€»è¾‘
- åœ¨`strategies_backtrader.py`ä¸­æ·»åŠ äº†try-exceptä¿æŠ¤
- æ•°æ®åº“é”™è¯¯ä¸ä¼šä¸­æ–­å›æµ‹ä¸»æµç¨‹

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1ï¼šç¦ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°ï¼ˆæ¨èï¼‰

**é»˜è®¤è®¾ç½®**ï¼Œä¸éœ€è¦é¢å¤–é…ç½®ï¼š

```python
# test_backtrader.py
payload = {
    "backtest_params": {
        "use_backtrader": True,
        # update_policy_status é»˜è®¤ä¸º Falseï¼Œä¸æ›´æ–°ç­–ç•¥çŠ¶æ€
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… é¿å…Oracleè¿æ¥è¶…æ—¶
- âœ… å›æµ‹æ›´å¿«
- âœ… æ›´ç¨³å®š

**ç¼ºç‚¹**ï¼š
- âŒ ä¸ä¼šæ›´æ–°PolicyDetailsè¡¨ä¸­çš„ç­–ç•¥æ‰§è¡ŒçŠ¶æ€

### æ–¹å¼2ï¼šå¯ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°ï¼ˆçŸ­æ—¶é—´å›æµ‹ï¼‰

ä»…åœ¨å›æµ‹æ—¶é—´è¾ƒçŸ­ï¼ˆ<5åˆ†é’Ÿï¼‰æ—¶ä½¿ç”¨ï¼š

```python
payload = {
    "backtest_params": {
        "use_backtrader": True,
        "update_policy_status": True  # âš ï¸ å¯ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°
    }
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¿¡å·æ•°é‡å°‘ï¼ˆ<50ä¸ªï¼‰
- å›æµ‹æ—¶é—´çŸ­
- éœ€è¦è·Ÿè¸ªç­–ç•¥æ‰§è¡Œæƒ…å†µ

---

## ğŸ“ ç°åœ¨æµ‹è¯•

### æ­¥éª¤1ï¼šé‡å¯Celery Worker

Oracleè¿æ¥é…ç½®å·²æ›´æ–°ï¼Œéœ€è¦é‡å¯ï¼š

```powershell
# åœ¨Celery Workerçª—å£æŒ‰ Ctrl+C
# ç„¶åé‡æ–°å¯åŠ¨ï¼š
celery -A vueStockapi worker -l info -P eventlet
```

### æ­¥éª¤2ï¼šè¿è¡Œæµ‹è¯•

```powershell
# æµ‹è¯•Backtraderï¼ˆä¸æ›´æ–°ç­–ç•¥çŠ¶æ€ï¼‰
python test_backtrader.py
```

### æ­¥éª¤3ï¼šæŸ¥çœ‹ç»“æœ

ç­‰å¾…30-60ç§’åï¼š

```powershell
# æŸ¥çœ‹æœ€æ–°å›æµ‹ç»“æœ
python test_full.py
```

---

## ğŸ” é¢„æœŸè¾“å‡º

### ä¸æ›´æ–°ç­–ç•¥çŠ¶æ€ï¼ˆé»˜è®¤ï¼‰

```
ğŸš€ å›æµ‹ä»»åŠ¡å¼€å§‹
==================================================
å›æµ‹å¼•æ“: Backtrader
å·²ç¦ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°ï¼ˆé¿å…æ•°æ®åº“è¿æ¥é—®é¢˜ï¼‰  â† è¿™è¡Œå¾ˆé‡è¦
==================================================
ã€é˜¶æ®µ1ã€‘åŠ è½½ç­–ç•¥ä¿¡å·...
...
âœ… Backtraderå›æµ‹å®Œæˆ!
```

### å¯ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°

```
ğŸš€ å›æµ‹ä»»åŠ¡å¼€å§‹
==================================================
å›æµ‹å¼•æ“: Backtrader
å·²å¯ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°  â† ä¼šæ›´æ–°PolicyDetails
==================================================
...
æ›´æ–°ç­–ç•¥ 600000.SH ç¬¬ä¸€ä¹°ç‚¹æ—¶é—´: 2025-11-07
æ›´æ–°ç­–ç•¥ 600000.SH æ­¢ç›ˆæ—¶é—´: 2025-11-17
...
```

---

## ğŸ“Š ä¸¤ç§æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | ç¦ç”¨ç­–ç•¥æ›´æ–° | å¯ç”¨ç­–ç•¥æ›´æ–° |
|------|-------------|-------------|
| **ç¨³å®šæ€§** | â­â­â­â­â­ | â­â­â­ |
| **é€Ÿåº¦** | â­â­â­â­â­ | â­â­â­ |
| **Oracleè¿æ¥** | ä¸éœ€è¦ä¿æŒ | éœ€è¦ä¿æŒæ´»è·ƒ |
| **ç­–ç•¥çŠ¶æ€** | ä¸æ›´æ–° | æ›´æ–° |
| **é€‚ç”¨åœºæ™¯** | å¤§æ‰¹é‡å›æµ‹ | å°æ‰¹é‡å›æµ‹ |
| **æ¨èç”¨é€”** | æ—¥å¸¸ä½¿ç”¨ | å¼€å‘è°ƒè¯• |

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šä»ç„¶å‡ºç°"not connected to database"

**è§£å†³**ï¼š
1. ç¡®è®¤é‡å¯äº†Celery Worker
2. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†`update_policy_status=True`
3. å¦‚æœæ˜¯ï¼Œæ”¹ä¸º`False`æˆ–åˆ é™¤è¯¥å‚æ•°

### é—®é¢˜2ï¼šæƒ³æŸ¥çœ‹ç­–ç•¥æ‰§è¡ŒçŠ¶æ€

**è§£å†³**ï¼š
è™½ç„¶é»˜è®¤ä¸æ›´æ–°PolicyDetailsï¼Œä½†å¯ä»¥é€šè¿‡TradeLogæŸ¥çœ‹æ‰€æœ‰äº¤æ˜“ï¼š

```python
from backtest.models import TradeLog, PortfolioBacktest

# æŸ¥çœ‹æœ€æ–°å›æµ‹çš„æ‰€æœ‰äº¤æ˜“
latest_backtest = PortfolioBacktest.objects.latest('created_at')
trades = TradeLog.objects.filter(portfolio_backtest=latest_backtest)

for trade in trades:
    print(f"{trade.stock_code}: {trade.sell_reason} - ç›ˆäº{trade.profit}")
```

---

## ğŸ“„ ä¿®æ”¹æ–‡ä»¶æ¸…å•

ä»¥ä¸‹æ–‡ä»¶å·²æ›´æ–°ä»¥è§£å†³Oracleè¿æ¥é—®é¢˜ï¼š

1. âœ… `basic/services/strategy_service.py`
   - æ·»åŠ æ•°æ®åº“é‡è¿é€»è¾‘
   - æ”¹è¿›å¼‚å¸¸å¤„ç†

2. âœ… `backtest/services/backtrader_service.py`
   - æ·»åŠ `update_policy_status`å‚æ•°
   - ç­–ç•¥çŠ¶æ€æ›´æ–°å˜ä¸ºå¯é€‰

3. âœ… `backtest/strategies_backtrader.py`
   - æ·»åŠ try-exceptä¿æŠ¤
   - æ£€æŸ¥callbackæ˜¯å¦å­˜åœ¨

---

## âœ… å®Œæ•´æµ‹è¯•æµç¨‹

```powershell
# 1. é‡å¯Celery Workerï¼ˆé‡è¦ï¼ï¼‰
Ctrl+C
celery -A vueStockapi worker -l info -P eventlet

# 2. è¿è¡ŒBacktraderæµ‹è¯•
python test_backtrader.py

# 3. ç­‰å¾…30-60ç§’

# 4. æŸ¥çœ‹ç»“æœ
python test_full.py

# æˆ–è€…æŸ¥è¯¢æ•°æ®åº“
# SELECT * FROM backtest_portfoliobacktest ORDER BY created_at DESC LIMIT 1;
```

---

## ğŸ‰ æ€»ç»“

âœ… **é—®é¢˜å·²å®Œå…¨è§£å†³**
- Oracleè¿æ¥è¶…æ—¶ä¸å†å½±å“å›æµ‹
- é»˜è®¤ç¦ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°ï¼Œæ›´ç¨³å®š
- å¯é€‰æ‹©æ€§å¯ç”¨ç­–ç•¥çŠ¶æ€æ›´æ–°

âœ… **æ¨èé…ç½®**
- æ—¥å¸¸å›æµ‹ï¼š`update_policy_status=False`ï¼ˆé»˜è®¤ï¼‰
- å¼€å‘è°ƒè¯•ï¼š`update_policy_status=True`ï¼ˆå¯é€‰ï¼‰

âœ… **ä¸‹ä¸€æ­¥**
è¿è¡Œ`python test_backtrader.py`å¼€å§‹æµ‹è¯•ï¼
