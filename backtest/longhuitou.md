**主题：** 使用 Backtrader 和 Tushare 实现“两连板回调+递归目标价+均线过滤”的复杂交易策略

**角色：** 你是一位资深的 Python 量化交易开发专家，精通 `Backtrader` 框架、`Pandas` 数据处理以及 `Tushare` 数据接口。

任务目标：

请编写一个完整的、面向对象的 Backtrader 策略脚本。该脚本需要从 Tushare 获取日线数据，支持多只股票同时回测，并包含严谨的资金管理、复杂的递归信号计算、二次加仓逻辑以及详细的交易日志记录。

**1. 数据获取与环境设置**

- **数据源：** 使用 `Tushare` API 获取日线数据（Open, High, Low, Close, Volume）。
- **Token 配置：** 代码需检查 `config.py` 或环境变量中的 Tushare Token。
- **标的列表：** 在代码顶部定义 `SYMBOLS` 列表（例如 `['600000.SH', '000001.SZ']`）。
- **起止时间：** 设定合理的回测时间段。

2. 策略参数与资金管理

请在策略类 Params 中定义以下可配置参数：

- `start_cash`: 初始资金（默认 1,000,000）。
- `buy_fraction`: 单笔买入占当前现金的比例（默认 0.05）。
- `limit_up_pct`: 涨停判定幅度（默认 0.098）。
- `take_profit`: 止盈倍数（默认 1.07，即收益 7% 卖出）。
- `stop_loss`: 止损阈值（默认 0.8，即基于**首次买入价**跌 20% 止损）。
- `second_buy_thresh`: 二次加仓阈值（默认 0.9，即基于**首次买入价**跌 10% 加仓）。
- `max_pos_per_stock`: 单只股票最大允许持仓次数（默认 2 次，即 1 次首仓 + 1 次加仓）。

**3. 核心策略逻辑（状态机与信号）**

- **定义：**
    - **涨停 (Limit Up)：** `(TodayClose - YesterdayClose) / YesterdayClose >= 0.098`。
    - **阴线 (Down Candle)：** `TodayClose < TodayOpen`。
    - **均线过滤器（新增）：** 计算 5 日均线 (SMA5) 和 60 日均线 (SMA60)。
- **信号触发流程（状态机）：**
    1. **阶段 A（涨停）：** 必须连续出现两天“涨停”（记为 ZT1, ZT2）。
    2. **阶段 B（回调）：** 紧接着 ZT2 后，必须连续出现两天“阴线”（记为 D1, D2）。
    3. **阶段 C（待选）：** D2 收盘后，进入“待选状态”。
- **目标买入价计算（核心递归算法）：**
    - 在 D2 收盘后计算 `target_buy_price`。
    - **初始窗口：** 取 ZT1 之前的连续 3 个交易日（ZT1-1, ZT1-2, ZT1-3）。
    - **递归逻辑：** 检查这 3 天窗口内是否存在“涨停”日。
        - 如果**存在**涨停（假设 ZT_prev 是窗口内的涨停日）：计算窗口向前移动，变为 ZT_prev 之前的 3 天，并**再次**执行此检查，直到找到一个**没有任何涨停**的 3 天窗口。
    - **最终价格：** 取该“无涨停 3 天窗口”内的**最高价 (High)** 作为 `target_buy_price`。

**4. 交易执行逻辑**

- **买入条件（必须同时满足）：**
    1. 股票处于“待选状态”（即走完 ZT1-ZT2-D1-D2 流程）。
    2. 当日最低价 `Low <= target_buy_price`。
    3. **均线过滤（新增）：** 当日 `SMA5 > SMA60`。
- **买入执行：**
    - **首次买入：** 若当前无持仓，按 `target_buy_price` 限价买入，使用 `buy_fraction` 资金。
    - **状态重置：** 买入触发后，重置该股票的信号状态，等待下一轮 ZT1。
- **二次加仓（补仓）：**
    - 若已有持仓且持仓次数 < `max_pos_per_stock`。
    - 条件：当日最低价 `<= 首次买入价 * second_buy_thresh`。
    - 执行：按当日收盘价或限价买入同等规模资金。
- **卖出逻辑（优先级高于加仓）：**
    - **止损：** 当日最低价 `<= 首次买入价 * stop_loss`，清空该股所有持仓。
    - **止盈：** 当日最高价 `>= 平均持仓成本 * take_profit`，清空该股所有持仓。

**5. 模拟设置与日志输出**

- **模拟：** 设置佣金 `commission=0.0003` (万三)，滑点 `slippage=0.001` (千一)。
- **日志 (CSV)：** 创建一个自定义 `Analyzer` 或在策略中记录。
    - 必须包含字段：`Date`, `Symbol`, `Operation` (Buy1/Buy2/Sell/StopLoss), `Price`, `Size`, `Cost`, `Profit`, `Cumulative_Cash`。
    - 回测结束后导出为 `trade_log.csv`。
    - 控制台打印最终总资金和收益率。