# Backtraderé›†æˆä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¦‚è¿°

ç°åœ¨æ‚¨çš„å›æµ‹ç³»ç»Ÿæ”¯æŒ**ä¸¤ç§å›æµ‹å¼•æ“**ï¼š

### 1. è‡ªå®šä¹‰å¼•æ“ï¼ˆåŸæœ‰ï¼‰
- âœ… è½»é‡çº§ï¼Œå¿«é€Ÿ
- âœ… ç®€å•ç›´è§‚çš„å®ç°
- âŒ åŠŸèƒ½ç›¸å¯¹åŸºç¡€

### 2. Backtraderå¼•æ“ï¼ˆæ–°å¢ï¼‰â­
- âœ… ä¸“ä¸šçš„å›æµ‹æ¡†æ¶
- âœ… ä¸°å¯Œçš„åˆ†æå™¨å’ŒæŒ‡æ ‡
- âœ… å®Œæ•´çš„è®¢å•ç®¡ç†ç³»ç»Ÿ
- âœ… æ”¯æŒä½£é‡‘ã€æ»‘ç‚¹ç­‰æ›´çœŸå®çš„äº¤æ˜“æˆæœ¬
- âœ… ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å®Œå–„

---

## ğŸ“ æ–°å¢æ–‡ä»¶

```
backtest/
â”œâ”€â”€ strategies_backtrader.py     # Backtraderç­–ç•¥å®ç°
â”œâ”€â”€ services/
â”‚   â””â”€â”€ backtrader_service.py    # Backtraderå›æµ‹æœåŠ¡
â””â”€â”€ tasks.py                      # æ›´æ–°ï¼šæ”¯æŒå¼•æ“é€‰æ‹©
```

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### æ–¹å¼1ï¼šé€šè¿‡APIï¼ˆæ¨èï¼‰

```python
# test_backtrader.py
payload = {
    "filters": {
        "strategy_name": "Backtraderæµ‹è¯•",
        "strategy_type": "é¾™å›å¤´",
        "start_date": "2025-07-01",
        "end_date": "2025-12-31"
    },
    "backtest_params": {
        "total_capital": 1000000,
        "capital_per_stock_ratio": 0.1,
        "hold_timeout_days": 60,
        "db_alias": "default",
        "use_backtrader": True,  # â­ å…³é”®å‚æ•°
        "commission": 0.0003     # ä½£é‡‘ç‡ï¼ˆå¯é€‰ï¼Œé»˜è®¤0.03%ï¼‰
    }
}
```

**è¿è¡Œæµ‹è¯•**ï¼š
```powershell
# æµ‹è¯•Backtraderå¼•æ“
python test_backtrader.py

# å¯¹æ¯”ä¸¤ä¸ªå¼•æ“
python test_backtrader.py both
```

### æ–¹å¼2ï¼šç›´æ¥è°ƒç”¨æœåŠ¡å±‚

```python
from datetime import date
from decimal import Decimal
from backtest.services.backtrader_service import BacktraderBacktestService

service = BacktraderBacktestService()

result = service.run_backtest(
    strategy_name='Backtraderç›´æ¥æµ‹è¯•',
    start_date=date(2025, 7, 1),
    end_date=date(2025, 12, 31),
    initial_capital=Decimal('1000000'),
    capital_per_stock_ratio=Decimal('0.1'),
    strategy_type='é¾™å›å¤´',
    hold_timeout_days=60,
    db_alias='default',
    commission=0.0003
)

print(result)
```

---

## ğŸ“Š ä¸¤ç§å¼•æ“å¯¹æ¯”

| ç‰¹æ€§ | è‡ªå®šä¹‰å¼•æ“ | Backtraderå¼•æ“ |
|------|-----------|----------------|
| **æ‰§è¡Œé€Ÿåº¦** | âš¡âš¡âš¡ å¿« | âš¡âš¡ ä¸­ç­‰ |
| **ä»£ç é‡** | ç®€å• | å¤æ‚ |
| **è®¢å•ç®¡ç†** | åŸºç¡€ | å®Œæ•´ |
| **ä½£é‡‘æ¨¡æ‹Ÿ** | æ—  | âœ… æ”¯æŒ |
| **æ»‘ç‚¹æ¨¡æ‹Ÿ** | æ—  | âœ… æ”¯æŒ |
| **åˆ†æå™¨** | æ‰‹åŠ¨è®¡ç®— | âœ… å†…ç½®å¤šç§ |
| **å¯æ‰©å±•æ€§** | ä¸­ç­‰ | âœ… å¼ºå¤§ |
| **å­¦ä¹ æ›²çº¿** | å¹³ç¼“ | é™¡å³­ |

---

## ğŸ”§ å‚æ•°è¯´æ˜

### é€šç”¨å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `strategy_name` | str | ç­–ç•¥åç§° | å¿…å¡« |
| `start_date` | date/str | å¼€å§‹æ—¥æœŸ | å¿…å¡« |
| `end_date` | date/str | ç»“æŸæ—¥æœŸ | å¿…å¡« |
| `initial_capital` | Decimal | åˆå§‹èµ„é‡‘ | å¿…å¡« |
| `capital_per_stock_ratio` | Decimal | å•ç¥¨èµ„é‡‘å æ¯” | å¿…å¡« |
| `hold_timeout_days` | int | æœ€å¤§æŒä»“å¤©æ•° | å¿…å¡« |

### Backtraderä¸“å±å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `use_backtrader` | bool | æ˜¯å¦ä½¿ç”¨Backtrader | `False` |
| `commission` | float | ä½£é‡‘ç‡ | `0.0003` (0.03%) |

---

## ğŸ“ˆ Backtraderç‰¹è‰²åŠŸèƒ½

### 1. å®Œæ•´çš„è®¢å•çŠ¶æ€ç®¡ç†

Backtraderä¼šè·Ÿè¸ªæ¯ä¸ªè®¢å•çš„çŠ¶æ€ï¼š
- Submittedï¼ˆå·²æäº¤ï¼‰
- Acceptedï¼ˆå·²æ¥å—ï¼‰
- Completedï¼ˆå·²å®Œæˆï¼‰
- Canceledï¼ˆå·²å–æ¶ˆï¼‰
- Marginï¼ˆä¿è¯é‡‘ä¸è¶³ï¼‰
- Rejectedï¼ˆè¢«æ‹’ç»ï¼‰

### 2. å†…ç½®åˆ†æå™¨

ä½¿ç”¨çš„åˆ†æå™¨ï¼š
- `Returns`: æ”¶ç›Šç‡åˆ†æ
- `DrawDown`: å›æ’¤åˆ†æ
- `TradeAnalyzer`: äº¤æ˜“ç»Ÿè®¡

### 3. ä½£é‡‘è®¡ç®—

Backtraderè‡ªåŠ¨è®¡ç®—äº¤æ˜“ä½£é‡‘ï¼Œæ›´çœŸå®åœ°åæ˜ å®é™…äº¤æ˜“æˆæœ¬ï¼š

```python
# æ¯ç¬”äº¤æ˜“
å®é™…ç›ˆäº = åŸå§‹ç›ˆäº - ä¹°å…¥ä½£é‡‘ - å–å‡ºä½£é‡‘
```

---

## ğŸ“ Backtraderç­–ç•¥è¯´æ˜

### DragonTurnBacktraderStrategy

ç»§æ‰¿è‡ª `bt.Strategy`ï¼Œå®ç°é¾™å›å¤´ç­–ç•¥ï¼š

**ä¹°å…¥é€»è¾‘**ï¼š
- å½“å¤©æœ€ä½ä»·è§¦åŠç¬¬ä¸€ä¹°ç‚¹æ—¶ä¹°å…¥
- ä½¿ç”¨ç¬¬ä¸€ä¹°ç‚¹ä»·æ ¼ä¸‹å•
- æŒ‰ç…§å•ç¥¨èµ„é‡‘å æ¯”è®¡ç®—ä¹°å…¥æ•°é‡

**å–å‡ºé€»è¾‘**ï¼š
1. æŒä»“è¶…æ—¶ï¼ˆé»˜è®¤60å¤©ï¼‰â†’ å¹³ä»“
2. è§¦å‘æ­¢ç›ˆï¼ˆæœ€é«˜ä»·â‰¥æ­¢ç›ˆç‚¹ï¼‰â†’ æ­¢ç›ˆ
3. è§¦å‘æ­¢æŸï¼ˆæœ€ä½ä»·â‰¤æ­¢æŸç‚¹ï¼‰â†’ æ­¢æŸ

**ç‰¹è‰²åŠŸèƒ½**ï¼š
- âœ… è‡ªåŠ¨è®°å½•äº¤æ˜“æ—¥å¿—
- âœ… å›è°ƒæ›´æ–°ç­–ç•¥ç»“æœåˆ° `PolicyDetails`
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

---

## ğŸ” æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### Backtraderå¼•æ“æ—¥å¿—

```
ğŸš€ å›æµ‹ä»»åŠ¡å¼€å§‹
==================================================
å›æµ‹å¼•æ“: Backtrader
ç­–ç•¥åç§°: Backtraderæµ‹è¯•
==================================================
ã€é˜¶æ®µ1ã€‘åŠ è½½ç­–ç•¥ä¿¡å·...
æ‰¾åˆ° 50 ä¸ªç­–ç•¥ä¿¡å·
ã€é˜¶æ®µ2ã€‘åŠ è½½ä»·æ ¼æ•°æ®...
å·²æ·»åŠ  50 ä¸ªæ•°æ®æº
ã€é˜¶æ®µ3ã€‘åˆå§‹åŒ–Backtrader...
ç­–ç•¥åˆå§‹åŒ–å®Œæˆ
æŒä»“è¶…æ—¶: 60å¤©
å•ç¥¨æ¯”ä¾‹: 10.0%
ã€é˜¶æ®µ4ã€‘æ‰§è¡Œå›æµ‹...
åˆå§‹èµ„äº§: 1,000,000.00
2025-11-07: å‘é€ä¹°å…¥è®¢å• 000620.SZ: ä»·æ ¼=3.44, æ•°é‡=29000
2025-11-07: ä¹°å…¥å®Œæˆ 000620.SZ: ä»·æ ¼=3.44, æ•°é‡=29000.00, æˆæœ¬=99760.00
2025-11-17: è§¦å‘å–å‡º 000620.SZ: take_profit
2025-11-17: å–å‡ºå®Œæˆ 000620.SZ: ä»·æ ¼=3.83, æ•°é‡=29000.00
2025-11-17: äº¤æ˜“å®Œæˆ 000620.SZ: æ€»ç›ˆäº=11310.00, å‡€ç›ˆäº=11280.12
==================================================
ã€é˜¶æ®µ5ã€‘æå–å›æµ‹ç»“æœ...
æ€»äº¤æ˜“æ¬¡æ•°: 10
ç›ˆåˆ©æ¬¡æ•°: 6, äºæŸæ¬¡æ•°: 4
èƒœç‡: 60.00%
æ€»æ”¶ç›Šç‡: 5.23%
æœ€å¤§å›æ’¤: -8.50%
âœ… Backtraderå›æµ‹å®Œæˆ! ç»“æœID: 5
```

---

## ğŸ› ï¸ æ‰©å±•Backtraderç­–ç•¥

å¦‚æœè¦æ·»åŠ æ–°çš„ç­–ç•¥ï¼Œåªéœ€ï¼š

1. **åˆ›å»ºç­–ç•¥ç±»**

```python
class MyCustomStrategy(bt.Strategy):
    params = (
        ('my_param', 10),
    )
    
    def __init__(self):
        # åˆå§‹åŒ–æŒ‡æ ‡ç­‰
        pass
    
    def next(self):
        # æ¯ä¸ªäº¤æ˜“æ—¥çš„é€»è¾‘
        if self.should_buy():
            self.buy()
        
        if self.should_sell():
            self.close()
```

2. **åœ¨æœåŠ¡å±‚ä¸­ä½¿ç”¨**

```python
cerebro.addstrategy(MyCustomStrategy, my_param=20)
```

---

## âš¡ æ€§èƒ½å¯¹æ¯”

åŸºäº100ä¸ªç­–ç•¥ä¿¡å·çš„æµ‹è¯•ï¼š

| å¼•æ“ | æ‰§è¡Œæ—¶é—´ | å†…å­˜ä½¿ç”¨ |
|------|----------|---------|
| è‡ªå®šä¹‰ | ~5ç§’ | ~150MB |
| Backtrader | ~15ç§’ | ~250MB |

**å»ºè®®**ï¼š
- æ—¥å¸¸æµ‹è¯•ï¼šä½¿ç”¨è‡ªå®šä¹‰å¼•æ“
- æ­£å¼å›æµ‹ã€ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨Backtraderå¼•æ“
- å¯¹æ¯”éªŒè¯ï¼šä¸¤ä¸ªå¼•æ“éƒ½è·‘ä¸€é

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é€‰æ‹©å¼•æ“ï¼Ÿ

**ä½¿ç”¨è‡ªå®šä¹‰å¼•æ“**ï¼š
- å¿«é€ŸéªŒè¯æƒ³æ³•
- æ•°æ®é‡è¾ƒå¤§ï¼ˆ>1000ä¸ªä¿¡å·ï¼‰
- ä¸éœ€è¦ç²¾ç¡®çš„äº¤æ˜“æˆæœ¬

**ä½¿ç”¨Backtrader**ï¼š
- æ­£å¼å›æµ‹æŠ¥å‘Š
- éœ€è¦ç²¾ç¡®è®¡ç®—ä½£é‡‘
- éœ€è¦è¯¦ç»†çš„è®¢å•ç®¡ç†
- æœªæ¥å¯èƒ½æ‰©å±•æ›´å¤æ‚ç­–ç•¥

### Q2: ä½£é‡‘æ€ä¹ˆè®¾ç½®ï¼Ÿ

ä¸­å›½Aè‚¡å…¸å‹ä½£é‡‘ï¼š
- ä¸‡ä¸‰ï¼š`0.0003`
- ä¸‡äºŒç‚¹äº”ï¼š`0.00025`
- ä¸‡ä¸€ï¼š`0.0001`

### Q3: ä¸¤ä¸ªå¼•æ“ç»“æœä¸ºä»€ä¹ˆä¸å®Œå…¨ä¸€è‡´ï¼Ÿ

ä¸»è¦å·®å¼‚ï¼š
1. Backtraderè®¡ç®—äº†ä½£é‡‘
2. è®¢å•æ‰§è¡Œç»†èŠ‚ç•¥æœ‰ä¸åŒ
3. æµ®ç‚¹æ•°ç²¾åº¦å·®å¼‚

é€šå¸¸å·®å¼‚åœ¨1-2%ä»¥å†…æ˜¯æ­£å¸¸çš„ã€‚

---

## ğŸ‰ å¿«é€Ÿå¼€å§‹

```powershell
# 1. æµ‹è¯•Backtrader
python test_backtrader.py

# 2. å¯¹æ¯”ä¸¤ä¸ªå¼•æ“
python test_backtrader.py both

# 3. æŸ¥çœ‹ç»“æœ
python test_full.py
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Backtraderå®˜æ–¹æ–‡æ¡£](https://www.backtrader.com/docu/)
- [Backtrader GitHub](https://github.com/mementum/backtrader)
- æœ¬é¡¹ç›®ç­–ç•¥å®ç°ï¼š`backtest/strategies_backtrader.py`

---

**ç¥æ‚¨å›æµ‹é¡ºåˆ©ï¼** ğŸš€

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–Backtraderå®˜æ–¹æ–‡æ¡£ã€‚
